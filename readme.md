# Прогнозирование цен акций МосБиржи

## Описание проекта

Данный проект представляет собой ВКР, целью которой является прогнозирование цен акций на Московской бирже с использованием классических методов машинного обучения. Проект объединяет разнородные источники данных:
- **Технические индикаторы:** исторические данные цен, объём торгов, индикаторы (RSI, MACD, скользящие средние и т.д.);
- **Фундаментальный анализ:** финансовые отчёты, коэффициенты (P/E, P/B, ROE) и дивидендные показатели;
- **Макроэкономические данные:** курсы валют, цены на нефть, биржевые индексы, ключевая ставка;
- **Новостной и экспертный анализ:** обработка новостного потока и экспертных мнений с использованием LLM через API для оценки тональности.

Ключевыми задачами проекта являются как построение прогностической модели цен акций на основе всестороннего сбора, обработки и интеграции данных из различных источников, так и эффективная суммаризация этой разнородной информации (новостей, аналитики, экспертных мнений, финансовых отчетов) для её предоставления пользователям в сжатом, понятном и информативном виде.

## Особенности

- **Многоступенчатая ETL-система:** Сбор, очистка и синхронизация данных из разных источников.
- **Фичеринжиниринг:** Расчёт технических индикаторов, обработка фундаментальных данных и оценка новостных лент.
- **Моделирование:** Использование классических алгоритмов ML с учетом временных рядов.
- **Бэктестинг:** Историческая симуляция для оценки эффективности прогноза и анализа рисков.
- **Автоматизация:** Скрипты и оркестрация процессов (ETL, переобучение моделей) для регулярного обновления данных.

## Структура проекта (текущая)

Ниже представлено описание ключевых файлов и директорий проекта, отражающее его текущее состояние.

### Конфигурационные файлы
- `configs/all_companies_config.json`: Конфигурация всех компаний для анализа с их тикерами и параметрами.
- `configs/annotator_config.json`: Настройки аннотатора для разметки текстовых данных.
- `configs/channels_config.json`: Конфигурация Telegram каналов для сбора новостных данных.
- `configs/clusterer_config.json`: Параметры алгоритма кластеризации текстов.
- `configs/final_structure.txt`: Итоговая структура данных и процессов.

### Исследовательские материалы
- `notebooks/MarketGenius_Research.ipynb`: Jupyter-блокнот с исследованием данных и разработкой моделей.

### Скрипты пайплайна данных
- `scripts/01_run_daily_update.py`: Ежедневное обновление данных и запуск основного пайплайна.
- `scripts/02_run_processing_pipeline.py`: Обработка собранных данных через ETL-процессы.
- `scripts/03_update_telegram_pipeline.py`: Обновление и обработка данных из Telegram каналов.
- `scripts/04_run_parallel_batches.py`: Параллельная обработка данных пакетами для повышения производительности.
- `scripts/05_filling_estimates.py`: Заполнение и корректировка оценок в датасете.
- `scripts/06_process_targets.py`: Обработка целевых переменных для машинного обучения.
- `scripts/07_prepare_daily_summary_batch_file.py`: Подготовка ежедневных сводных файлов для обработки.
- `scripts/08_process_daily_summary_batches.py`: Обработка ежедневных сводок пакетами.
- `scripts/09_publish_pipeline.py`: Публикация результатов и отправка уведомлений.
- `scripts/10_generate_predictions.py`: Генерация предсказаний для всех тикеров.
- `scripts/market_genius_dag.py`: DAG-файл для оркестрации всего пайплайна в Airflow.

### Модули сбора данных (`src/data_ingestion`)
- `01_run_initial_load.py`: Первоначальная загрузка исторических данных.
- `02_technicalIndicators.py`: Расчёт технических индикаторов для финансовых инструментов.
- `03_process_financial_reports.py`: Обработка финансовой отчётности компаний.
- `04_merge_features.py`: Объединение различных типов признаков в единый датасет.
- `05_calculate_financial_ratios.py`: Расчёт финансовых коэффициентов компаний.
- `06_preprocess_features.py`: Предварительная обработка и нормализация признаков.
- `usd_rub_loader.py`: Загрузчик курса валют.
- `indexes_moex.py`: Получение данных индексов Московской биржи.
- `oil_prices_loader.py`: Загрузчик цен на нефть и газ.
- `key_rate_loader.py`: Получение данных о ключевой ставке ЦБ РФ и инфляции.
- `moex_parser.py`: Парсер данных с Московской биржи.
- `download_issue_size.py`: Загрузка данных об объёмах эмиссии ценных бумаг.
- `create_trading_calendar.py`: Создание календаря торговых дней.
- `fin_otchet.py`: Обработчик финансовых отчётов компаний.

### ETL-процессы (`src/etl`)
- `00_telegram_parser.py`: Парсинг сообщений из Telegram каналов.
- `01_clean_text.py`: Очистка и предобработка текстовых данных.
- `02_compute_embeddings.py`: Вычисление векторных представлений текстов.
- `03_clusterer.py`: Кластеризация текстовых данных по тематикам.
- `04_prepare_batch_file.py`: Подготовка пакетных файлов для обработки.
- `05_process_batch_sequence.py`: Последовательная обработка пакетов данных LLM моделью.
- `06_process_batch_results.py`: Обработка результатов пакетного анализа.
- `generate_telegram_messages.py`: Генерация сообщений для публикации в Telegram.
- `telegram_publisher.py`: Публикация результатов в Telegram канале.

### Утилиты (`src/utils`)
- `gpt_analyzer.py`: Анализатор текстов с использованием OpenAI API.
- `gpt_batch_analyzer.py`: Пакетный анализатор текстов через GPT API.
- `data_loader.py`: Загрузчик данных для моделей.
- `ticker_cleaner.py`: Очистка и стандартизация тикеров акций.

### Промпты для LLM (`src/prompts`)
- `news_promt.txt`: Промпт для анализа новостных текстов.
- `blogs_promt.txt`: Промпт для анализа блоговых постов.
- `daily_aggregate_promt.txt`: Промпт для ежедневной агрегации результатов.

### Документация проекта
- `readme.md`: Основная документация проекта с описанием назначения и использования системы.
- `notebooks/market_genius_model_results_v2.csv`: Основные результаты с метриками моделей.

Более подробное описание первоначальной структуры и её эволюции можно найти в [PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md) и [PLANNING.md](PLANNING.md).

## Архитектура проекта

Проект «Market Genius» разрабатывается с ориентацией на микросервисную архитектуру, удобство CI/CD и observability.

### Ключевые компоненты и слои:

1.  **Сбор данных (`src/marketgenius/ingestion/`)**: Модули для инкрементальной загрузки данных из различных источников (MOEX, CBR, Telegram и др.). Каждый источник представлен отдельным `loader`-ом.
2.  **Обработка и трансформация (ETL/Pipelines)**:
    *   **Пайплайны (`src/marketgenius/pipelines/`)**: Используются Airflow для оркестрации потоков данных, таких как обработка новостей из Telegram (`telegram_news.py`), обновление макроэкономических показателей (`macro_update.py`) и переобучение моделей (`retrain_model.py`).
    *   **Фичеринжиниринг (`src/marketgenius/features/`)**: Генерация признаков для моделей, включая технические индикаторы, фундаментальные показатели и анализ тональности текста.
3.  **Машинное обучение (`src/marketgenius/models/`)**: Включает в себя разработку, обучение, оценку и бэктестинг ML/TS моделей.
4.  **Сервисы (`src/marketgenius/services/`)**:
    *   **API (`api.py`)**: REST-интерфейс на FastAPI для получения прогнозов (например, `/predict`).
    *   **Worker (`worker.py`)**: Фоновый обработчик задач (Celery/RQ) для выполнения ресурсоёмких операций.
    *   **Telegram Publisher (`telegram_publisher.py`)**: Бот для публикации саммари новостей и инсайтов в Telegram-канал.
    *   **Telegram Query Bot (`telegram_query_bot.py`)**: Интерактивный Telegram-бот для запроса информации из итоговых файлов с признаками.
5.  **Инфраструктура (`infra/`)**: Код для управления инфраструктурой (IaC).
    *   **Docker (`infra/docker/`)**: Dockerfiles для сборки образов (`api`, `worker`, `scheduler`, `telegram_publisher`, `telegram_query_bot`).
    *   **Kubernetes (`infra/k8s/`)**: Манифесты для развёртывания в Kubernetes.
    *   **Terraform (`infra/terraform/`)**: Опционально, для provisioning облачных ресурсов.
6.  **Данные (`data/`)**:
    *   `data/raw`: Неизменённые сырые данные.
    *   `data/processed`: Очищенные и предобработанные данные, включая `staging` и `features`.
7.  **Конфигурация (`configs/`, `core/config.py`)**: YAML/JSON файлы для настроек, которые читаются через Pydantic `BaseSettings`, с возможностью переопределения через переменные окружения.
8.  **CLI (`src/marketgenius/cli.py`)**: Интерфейс командной строки на Typer для вспомогательных dev-задач.

### Технологический стек (основные компоненты):

| Слой                | Инструменты/Библиотеки                     |
|---------------------|--------------------------------------------|
| ETL / Orchestration | Airflow                                    |
| Хранение данных     | Parquet + DuckDB / Postgres                |
| ML/TS модели        | scikit-learn, PyTorch, LightGBM            |
| NLP                 | OpenAI API, sentence-transformers          |
| API-слой            | FastAPI + Uvicorn                          |
| User Interaction    | Telegram Bot API (aiogram)                 |
| CI/CD               | GitHub Actions, Docker, Kubernetes (опц.)  |
| Контейнеризация     | Docker, Docker Compose                     |

### Ключевые принципы:

*   **Единый Python-пакет `marketgenius`**: Используется как зависимость во всех сервисах.
*   **Разделение кода и инфраструктуры**: `src/` для кода, `infra/` для IaC.
*   **Конфигурация через файлы и ENV**: Никаких hardcoded значений в коде.
*   **Observability**: `/health` и `/metrics` эндпоинты, структурированное JSON-логирование.
*   **CI/CD**: Автоматизация линтинга, тестов, сборки и деплоя.

## Контейнеры и их назначение:

| Образ              | Компонент                                  | Команда Entrypoint                                       |
|--------------------|--------------------------------------------|----------------------------------------------------------|
| `mg-api`           | FastAPI сервер                             | `uvicorn marketgenius.services.api:app --host 0.0.0.0 --port 8000` |
| `mg-worker`        | Celery/RQ задачи (ETL, retrain)            | `python -m marketgenius.services.worker`                   |
| `mg-scheduler`     | Prefect/Beat                               | `prefect agent start -q default`                         |
| `mg-telegram-pub`  | Telegram Publisher bot                     | `python -m marketgenius.services.telegram_publisher`       |
| `mg-telegram-bot`  | Telegram Query bot                         | `python -m marketgenius.services.telegram_query_bot`       |

## Дальнейшие шаги

План развития проекта, включая следующие спринты и цели, описан в [PLANNING.md](PLANNING.md).
